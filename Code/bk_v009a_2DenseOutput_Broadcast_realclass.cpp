#include <Arduino.h>
#include <ECG2_inferencing.h>
#include <ArduinoBLE.h>

/**Defines**/
//#define TRUE 1

/**BLE UUID**/
//const char* deviceServiceUuid = "19b10000-e8f2-537e-4f6c-d104768a1214";
//const char* deviceServiceCharacteristicUuid = "19b10001-e8f2-537e-4f6c-d104768a1214";

/**Static ECG data**/
static const float ecg_sample_data[][260] = {
{-0.424480751,-0.425414357,-0.427285194,-0.428280058,-0.424362303,-0.419251776,-0.411402611,-0.403828657,-0.405965562,-0.411233431,-0.41816596,-0.425321039,-0.425416343,-0.422761139,-0.420264243,-0.417116683,-0.413463137,-0.409926843,-0.405679038,-0.401800463,-0.402182605,-0.404628061,-0.40533641,-0.406625608,-0.41186594,-0.416815735,-0.427343,-0.436510507,-0.425723486,-0.409591674,-0.385947135,-0.362807615,-0.367756761,-0.381779277,-0.400507875,-0.419926286,-0.419749447,-0.412161455,-0.403992164,-0.393959124,-0.385491069,-0.377836373,-0.367697835,-0.358002159,-0.355775526,-0.356016253,-0.357118699,-0.358264058,-0.354642445,-0.34865781,-0.343053097,-0.336329054,-0.325776223,-0.313725088,-0.300618771,-0.287183918,-0.277066937,-0.267697974,-0.258361566,-0.248885809,-0.235592835,-0.220129653,-0.209232561,-0.198068296,-0.176902052,-0.155690084,-0.126717413,-0.100030851,-0.111331542,-0.139170857,-0.153601778,-0.201154671,-0.199024518,-0.186647027,-0.173484753,-0.16314011,-0.151860914,-0.167869548,-0.175169263,-0.184895511,-0.188137129,-0.191254286,-0.192831667,-0.196430363,-0.21383051,-0.237232346,-0.26337112,-0.289549478,-0.318134897,-0.333879126,-0.354575698,-0.374610823,-0.401570625,-0.430246712,-0.45464347,-0.477247325,-0.500062319,-0.517654126,-0.54140094,-0.5591239,-0.536914662,-0.500479332,-0.453521892,-0.404487919,-0.387529162,-0.381837059,-0.378664713,-0.370285211,-0.371371558,-0.37348834,-0.357996643,-0.335022146,-0.3292967,-0.317429462,-0.295769778,-0.254494994,-0.156530531,-0.016327063,0.132162861,0.310174527,0.583237994,0.88545447,1.222425361,1.552678287,1.766416996,1.931047824,2.026296854,2.088554601,2.232741749,2.370642412,2.506445571,2.599890736,2.499437305,2.304896069,2.061131545,1.775455603,1.495323918,1.214006478,0.910369549,0.612890769,0.381824966,0.188440374,0.008464343,-0.145618163,-0.251334928,-0.321932185,-0.384985128,-0.42622109,-0.409555637,-0.370551188,-0.313637115,-0.2534764,-0.255510265,-0.283234245,-0.292864282,-0.324140027,-0.335350624,-0.295202003,-0.266431671,-0.23095427,-0.202720814,-0.177564223,-0.14907142,-0.123065643,-0.11329778,-0.111539177,-0.110035882,-0.111981729,-0.120149348,-0.129597436,-0.147090431,-0.16408192,-0.158066937,-0.145882295,-0.126053989,-0.106654708,-0.116707879,-0.136069531,-0.160273635,-0.184905055,-0.18789745,-0.182458825,-0.176561005,-0.168356063,-0.160607291,-0.153477099,-0.142509555,-0.13207726,-0.133089534,-0.13758401,-0.144241298,-0.15082131,-0.147130987,-0.139195846,-0.131472581,-0.122520435,-0.111972877,-0.103093988,-0.087956612,-0.065067474,-0.091107202,-0.065566868,-0.069420655,-0.072000394,-0.071504975,-0.069188626,-0.060813086,-0.050357193,-0.045139528,-0.040982514,-0.036529956,-0.031590989,-0.023947673,-0.01461407,-0.004872648,0.000432341,0.021973872,0.013911837,0.014324617,0.018724655,0.035981613,0.057316681,0.081009032,0.103128691,0.111052871,0.114521844,0.104033112,0.107127007,0.099384853,0.096874337,0.090285196,0.082622672,0.072137797,0.059971407,0.045959081,0.030758912,0.01569815,-0.000159162,-0.015422957,-0.031482976,-0.0519383,-0.073405945,-0.097878852,-0.122168474,-0.136638646,-0.148299367,-0.157958946,-0.167836686,-0.187440224,-0.210851591,-0.234726529,-0.259537001,-0.283428302,-0.306690049,-0.330965622,-0.354648728,-0.373873675,-0.391211826,-0.407781404,-0.423589634},
{-0.161242262,-0.168441288,-0.176034352,-0.183411699,-0.19105309,-0.200541947,-0.21028575,-0.22071118,-0.230685747,-0.23625723,-0.239862464,-0.243475719,-0.24534826,-0.248982179,-0.257271683,-0.239978536,-0.24928713,-0.258024792,-0.271529139,-0.268047345,-0.260516979,-0.262978455,-0.268126406,-0.271462774,-0.275697761,-0.278257805,-0.276869742,-0.295827729,-0.282690621,-0.295831414,-0.310252702,-0.312165736,-0.310416415,-0.315375779,-0.321802643,-0.326849372,-0.331651574,-0.336252314,-0.34073328,-0.34491154,-0.349020347,-0.353620024,-0.358313307,-0.363153946,-0.367945683,-0.37201459,-0.37490243,-0.379844912,-0.38933803,-0.377274054,-0.396137905,-0.39775721,-0.400317665,-0.404918043,-0.409870824,-0.414686865,-0.418697677,-0.41840491,-0.416069105,-0.413096998,-0.409254734,-0.405216655,-0.401090276,-0.395623181,-0.39018847,-0.387502627,-0.385351523,-0.385599517,-0.385809649,-0.379418174,-0.371932173,-0.36098521,-0.350140495,-0.355351632,-0.366225617,-0.368980968,-0.368097214,-0.378568236,-0.385862105,-0.372943257,-0.355304575,-0.296269812,-0.22768693,-0.24669861,-0.290328318,-0.283531827,-0.269705905,-0.251041248,-0.232853793,-0.277899316,-0.343936811,-0.355030663,-0.354962883,-0.394608962,-0.442598112,-0.48703336,-0.527127995,-0.541449039,-0.542220225,-0.542943092,-0.536795567,-0.516220248,-0.493175377,-0.447949354,-0.417892971,-0.412633504,-0.416231097,-0.4477839,-0.485558267,-0.449921547,-0.421266559,-0.364596769,-0.318701507,-0.413742853,-0.567014897,-0.681716324,-0.798856757,-0.974416983,-1.125253088,-1.328068307,-1.459931619,-1.245283164,-0.806139821,-0.283221315,0.394952798,1.461579284,2.656307887,4.01484777,5.285146095,6.127029537,6.46771092,5.802359078,4.487630478,2.88480418,1.206372076,-0.053402062,-0.88782123,-1.190329609,-1.176091216,-0.999806792,-0.711759889,-0.57734781,-0.487178602,-0.397793865,-0.33394018,-0.342627125,-0.385329302,-0.449837132,-0.526074146,-0.572412825,-0.606954622,-0.648231448,-0.683818786,-0.693133857,-0.689579755,-0.679336497,-0.662817,-0.647138891,-0.629298318,-0.607403999,-0.583119031,-0.556856539,-0.528722085,-0.502420996,-0.475720379,-0.442640498,-0.40966546,-0.374304894,-0.342071726,-0.330181607,-0.327120482,-0.329409796,-0.337594388,-0.333918744,-0.343788885,-0.348908673,-0.35568151,-0.364539888,-0.374801168,-0.383269546,-0.391692513,-0.404058131,-0.417474115,-0.428625452,-0.430127619,-0.452230604,-0.419479702,-0.410808081,-0.40048484,-0.374350978,-0.366777878,-0.346935289,-0.326861319,-0.307181831,-0.287361648,-0.268006091,-0.248555012,-0.22661831,-0.204747516,-0.182063048,-0.160651689,-0.147069795,-0.137124571,-0.128923251,-0.122371876,-0.115235234,-0.108537795,-0.102930253,-0.097963574,-0.093524991,-0.089623509,-0.085465818,-0.081555906,-0.079222812,-0.077049539,-0.0756261,-0.073715466,-0.067529748,-0.059570631,-0.050662443,-0.041177686,-0.032917425,-0.024773411,-0.017353001,-0.010236669,0.000202966,0.011496969,0.018311641,0.02384192,0.032475226,0.041087814,0.049366559,0.056343191,0.057737811,0.056283342,0.053559442,0.04938919,0.04460586,0.039154699,0.032438679,0.02517118,0.01900084,0.012957327,0.006553378,-0.000125739,-0.007449931,-0.015252406,-0.02320691,-0.031537509,-0.040666773,-0.050201799,-0.060352193,-0.070750197,-0.080368198,-0.089971734,-0.099409063,-0.109032754,-0.120548174,-0.132839657,-0.14451424},
{0.21581732,0.213433997,0.207901919,0.196102925,0.180695048,0.164034126,0.14508574,0.12668535,0.106913503,0.079864065,0.051695954,0.020597588,-0.008681648,-0.020937672,-0.025755798,-0.028006944,-0.027412761,-0.02802288,-0.028429637,-0.026571708,-0.024072908,-0.02475334,-0.027135344,-0.02570322,-0.031758974,-0.02947673,-0.026898549,-0.023580482,-0.021523971,-0.027879605,-0.037945179,-0.049623247,-0.062710733,-0.074452877,-0.086138306,-0.098498493,-0.111031102,-0.123872168,-0.136866063,-0.148622071,-0.159966356,-0.173156482,-0.185869472,-0.198537599,-0.209643079,-0.213621751,-0.21370828,-0.213420837,-0.211304065,-0.204647854,-0.196354426,-0.187022743,-0.177205569,-0.174006539,-0.17554211,-0.163914319,-0.147512239,-0.176315598,-0.191150307,-0.197429214,-0.179770978,-0.155064836,-0.123546928,-0.077650207,-0.029242052,-0.010220109,0.000277559,0.007099408,0.013656858,0.041500222,0.077273044,0.110361921,0.143905994,0.179454708,0.212193935,0.246406051,0.275376136,0.278454712,0.268287108,0.255414976,0.236329336,0.208784627,0.17813694,0.138678778,0.098482197,0.081117014,0.070951986,0.060588429,0.049986077,0.029108741,0.001454233,-0.021391315,-0.046776383,-0.099360081,-0.16148246,-0.209903714,-0.255443265,-0.306213231,-0.355700301,-0.404503285,-0.449177819,-0.478072752,-0.498976191,-0.513460488,-0.523321423,-0.536409866,-0.547448075,-0.556902514,-0.562786763,-0.556012337,-0.542186104,-0.528417088,-0.515919339,-0.484493183,-0.480990271,-0.453395745,-0.399768987,-0.41523806,-0.43451599,-0.436178763,-0.384577757,-0.311511555,-0.17921359,-0.015404653,0.215645195,0.663166221,1.190488322,1.804080413,2.381591344,2.823973049,3.113040364,3.023983927,2.71415969,2.225945925,1.598885517,0.962028835,0.258338494,-0.5049282,-1.221165233,-1.725542007,-2.030438552,-2.097735662,-2.024831646,-1.945372691,-1.831045857,-1.738504783,-1.648855884,-1.534777521,-1.420542736,-1.353013646,-1.304051468,-1.261865213,-1.226560214,-1.183633553,-1.141774226,-1.103817982,-1.07016036,-1.047048811,-1.030297045,-1.017616417,-1.009039716,-1.002836312,-0.999266299,-0.999353237,-1.001500543,-1.004457973,-1.008915842,-1.014624318,-1.022160873,-1.031884923,-1.041657018,-1.060215685,-1.069812763,-1.082578112,-1.094559543,-1.106607113,-1.118706199,-1.131703434,-1.145261545,-1.158966941,-1.173094001,-1.188327425,-1.204144848,-1.220224935,-1.236540941,-1.252904863,-1.26927617,-1.285642434,-1.301884759,-1.31776655,-1.333294444,-1.348656075,-1.363612024,-1.37769039,-1.391196599,-1.403999556,-1.416236646,-1.428742672,-1.440927744,-1.451908854,-1.462042457,-1.472079433,-1.481058621,-1.489275481,-1.495932659,-1.498394019,-1.498189828,-1.49672745,-1.493441987,-1.487675503,-1.480310277,-1.470892113,-1.460223425,-1.451307766,-1.442369792,-1.430986705,-1.418327884,-1.406519433,-1.393135061,-1.379174246,-1.362612175,-1.33633895,-1.304719033,-1.271991465,-1.236591033,-1.19652461,-1.154739545,-1.109767317,-1.0644661,-1.028549047,-0.996265976,-0.961427647,-0.926754645,-0.895927512,-0.864074153,-0.834783155,-0.802534866,-0.750122295,-0.689003632,-0.62535238,-0.559089366,-0.495034732,-0.432217982,-0.368225115,-0.306067228,-0.250797233,-0.199463036,-0.154182034,-0.112653233,-0.06778263,-0.026371785,0.014735484,0.049447066,0.060458026,0.060208535,0.047414802,0.02654899,0.023322704,0.021543445,-0.004734224},
{-0.149545314,-0.159120739,-0.130406847,-0.153934166,-0.148245956,-0.141665123,-0.145445053,-0.136271561,-0.129340887,-0.111655164,-0.137316047,-0.116569591,-0.088276075,-0.109497388,-0.096439949,-0.08234527,-0.071704085,-0.061978083,-0.050274718,-0.038367773,-0.027073648,-0.020432801,-0.005480341,-0.015876645,-0.017260962,-0.021063459,-0.021200219,-0.022654114,-0.022759389,-0.025591024,-0.032890989,-0.028016832,-0.079002021,-0.042123844,-0.086457796,-0.092799315,-0.084235112,-0.117929727,-0.103591844,-0.081519026,-0.053067831,-0.018041456,-0.006444107,0.031162421,0.047989641,0.071901181,0.103765802,0.165073326,0.24029847,0.204371722,0.251235577,0.267690841,0.320072237,0.371411827,0.379513303,0.36998777,0.357953139,0.338585679,0.324233162,0.314916596,0.265966283,0.272647904,0.22395457,0.214613396,0.18334301,0.149324532,0.141063613,0.072500558,0.092335839,0.02268801,0.004647361,-0.015447336,-0.035700731,-0.058220635,-0.081042188,-0.099911252,-0.145772096,-0.135508285,-0.193569321,-0.167954716,-0.195978769,-0.196395745,-0.216269039,-0.2057872,-0.206278223,-0.208870921,-0.23833593,-0.277892928,-0.325784754,-0.365849855,-0.415398449,-0.468064375,-0.502860516,-0.551179332,-0.594142098,-0.578895016,-0.58143025,-0.578512263,-0.575613656,-0.590810904,-0.576546392,-0.569634963,-0.566941486,-0.50900723,-0.494513612,-0.475983495,-0.385956354,-0.283009629,-0.185497965,-0.03553153,-0.0877871,-0.196379345,-0.314593672,-0.423998482,-0.482295541,-0.450686569,-0.411022089,-0.297065796,-0.207369394,-0.099173728,0.04798308,0.282668602,0.729674758,1.414621109,2.085725635,2.823913135,3.705673057,4.621757933,5.564984339,6.478448207,7.24909707,7.688932658,7.439370104,6.570113903,5.06196282,3.120653942,0.98283488,-1.052599576,-2.429106334,-3.155438634,-3.090671735,-2.541484995,-1.916341041,-1.325208548,-0.929476339,-0.694803022,-0.553239396,-0.488237385,-0.418479276,-0.369741068,-0.326274958,-0.29463969,-0.283982675,-0.248717729,-0.309186883,-0.38707595,-0.495533598,-0.612508313,-0.561512293,-0.528105022,-0.501269394,-0.400516868,-0.332073798,-0.267090482,-0.227611007,-0.140324701,-0.111233774,-0.136578999,-0.153140144,-0.190951118,-0.170714402,-0.23251398,-0.260552813,-0.299466835,-0.289126429,-0.322718972,-0.331952899,-0.331767278,-0.345356003,-0.354532547,-0.364262244,-0.372005197,-0.376531675,-0.377163391,-0.377330209,-0.375534704,-0.372465154,-0.369731007,-0.357935517,-0.351055692,-0.351657453,-0.346958141,-0.322072443,-0.306331983,-0.347966227,-0.280305556,-0.304328371,-0.249190201,-0.29058176,-0.221136055,-0.20793782,-0.193278928,-0.141987084,-0.150321446,-0.074732023,-0.068517305,-0.047464596,-0.000459969,0.029462941,0.060263206,0.091349534,0.120974747,0.166464144,0.1824965,0.23972004,0.264202739,0.305800053,0.347228493,0.386577461,0.420435155,0.479398793,0.505147283,0.544761011,0.580294277,0.614630624,0.6487335,0.679541664,0.702119021,0.758428185,0.769000283,0.802423887,0.844084719,0.879247396,0.916097504,0.944242675,0.9706212,0.993445513,1.015191945,1.052906869,1.087797826,1.12478703,1.171337235,1.168757169,1.231128964,1.269234136,1.285472405,1.271792673,1.236841575,1.211231411,1.127648585,1.122771971,1.044100495,0.981027561,0.934468776,0.86575789,0.793677423,0.726427145,0.661139673,0.574413426,0.507304107},
{0.310536307,0.330063068,0.337581028,0.423410074,0.40015783,0.422241656,0.437998687,0.428516174,0.408153623,0.451821357,0.510883936,0.487180346,0.442365447,0.447057007,0.463301389,0.478070919,0.489844153,0.490348623,0.456050377,0.460661886,0.469822521,0.493271985,0.520851745,0.509679146,0.489219661,0.49571264,0.506961578,0.529779922,0.557192574,0.534009009,0.522092093,0.510856185,0.50042301,0.56495421,0.647190965,0.613523324,0.558600535,0.531632503,0.590866537,0.603735801,0.623935996,0.613316965,0.641638714,0.646208364,0.652340074,0.667301444,0.682595544,0.705153199,0.744716662,0.704838353,0.773167034,0.784300141,0.797530175,0.808200184,0.819257138,0.814575327,0.835780131,0.814864576,0.846081907,0.87156483,0.866855298,0.861546029,0.845458371,0.85078134,0.859837981,0.807925521,0.748540095,0.732433174,0.738555732,0.806515574,0.890090698,0.974073704,0.983560122,1.044421802,1.099811709,1.213102715,1.251782862,1.353004224,1.46931113,1.559155873,1.636787412,1.855377203,2.073765983,2.133230877,2.057336365,2.046824419,2.037917791,2.00861749,1.941572247,1.817326271,1.670213606,1.541260918,1.376102489,1.355989423,1.413636073,1.203626831,0.941810826,0.744228667,0.68947128,0.547802567,0.418708525,0.361922457,0.346143277,0.303039356,0.262473031,0.351390968,0.464342753,0.461681953,0.434188126,0.407356909,0.458325715,0.44963108,0.441000399,0.481308693,0.540981444,0.563362756,0.577637164,0.650306056,0.732404865,0.763511546,0.762843442,0.598559017,0.437295356,0.229572827,0.160589995,0.51707689,1.356507283,2.329717752,3.424685806,4.52585859,5.384200377,5.820424394,5.573922935,4.155870907,2.19391673,0.640958409,-0.248150307,-0.392858385,-0.12653012,0.203417501,0.594774313,0.621952785,0.549658199,0.392283953,0.300615198,0.32745285,0.406680079,0.505406664,0.608810188,0.620396883,0.596239219,0.573004041,0.557648093,0.493528084,0.513388058,0.527875933,0.467081543,0.487268932,0.52080664,0.550005161,0.581615937,0.617729234,0.653819245,0.696496798,0.731870398,0.757134239,0.733272614,0.734412629,0.756793383,0.646946628,0.717966903,0.687673335,0.663056381,0.647287562,0.635784296,0.623910258,0.611303711,0.597520709,0.588447122,0.552820477,0.567612169,0.534859773,0.564804249,0.573201673,0.582080693,0.594517066,0.638210683,0.543679762,0.647242467,0.679450854,0.652317336,0.674296404,0.71330713,0.678051894,0.739006351,0.750080114,0.765817648,0.756578049,0.765453018,0.758755121,0.748921412,0.741510535,0.734610125,0.70902864,0.737001461,0.653482898,0.699333376,0.68245174,0.662132796,0.649769994,0.639020502,0.62603467,0.612116035,0.59648703,0.578911932,0.562318189,0.551142241,0.515079379,0.507695636,0.50551432,0.478257174,0.458884833,0.461697848,0.34715776,0.346483446,0.4121114,0.407848755,0.359609105,0.286541986,0.276452924,0.283099236,0.282191265,0.280113694,0.27746012,0.286629972,0.245197349,0.252041964,0.304894183,0.248032177,0.25465919,0.255985707,0.260731054,0.278160352,0.226439192,0.271497284,0.263032373,0.257677321,0.255551705,0.255535667,0.254928643,0.253073578,0.256667331,0.267973927,0.241516524,0.239272153,0.266897432,0.264119288,0.259525943,0.248900608,0.252516149},
}; 


/**Adjusted inference structure for 2D array**/
typedef struct {
  const float (*buffer)[260];  // Pointer to a 2D array
  uint32_t buf_count;
  uint32_t n_samples;
  uint32_t n_rows;
} inference_t;

/**Initialize inference structure for 2D array**/
static inference_t inference = {
  ecg_sample_data,
  0,
  sizeof(ecg_sample_data[0]) / sizeof(ecg_sample_data[0][0]),
  sizeof(ecg_sample_data) / sizeof(ecg_sample_data[0])
};

static bool debug_nn = false;


/**Power Saver**/
void PowerSave_Settings(void){
  ///Saves 4mA
  digitalWrite(LED_PWR, LOW);   //Turn off the power LED
  digitalWrite(PIN_ENABLE_SENSORS_3V3, LOW);    //Turn off the sensors
  digitalWrite(PIN_ENABLE_I2C_PULLUP, LOW);   //Turn off the I2C pull-up resistors
}

/**Serial Settings
void Serial_Settings(void){
  Serial.begin(9600);
  while (!Serial);  
}**/


/**BLE Pre-Settings**/
void BLE_Settings(void){
  if (!BLE.begin()) {
    while (1);
  }

  String dataToSend = "x"; 
  BLE.setLocalName(dataToSend.c_str());
  BLE.setAdvertisedServiceUuid("180C");
  BLE.advertise();
  BLE.end();
}


/**Get raw ECG signal data for a specific row in the 2D array**/
static int ecg_signal_get_data(size_t offset, size_t length, float *out_ptr) {
  if (offset + length > inference.n_samples) {
      return -1; // Out of range
  }
  for (size_t i = 0; i < length; ++i) {
      out_ptr[i] = inference.buffer[inference.buf_count][offset + i];
  }
  return 0;
}


/************************************/
void Inference_BLE(){

  for (uint32_t row = 0; row < inference.n_rows; row++) {
    //Serial.println(String(row));

    signal_t signal;
    signal.total_length = inference.n_samples;
    inference.buf_count = row; // Set the current row to process
    signal.get_data = &ecg_signal_get_data;
    ei_impulse_result_t result = {0};

    EI_IMPULSE_ERROR r = run_classifier(&signal, &result, debug_nn);
    if (r != EI_IMPULSE_OK) {
        continue; // Skip to next iteration
    }


    //Serial.println(String(result.classification[0].value));
    float threshold = 0.7;
    if( (result.classification[16].value>threshold && row < 100) ||
        (result.classification[17].value>threshold && row > 99 && row < 200) ||
        (result.classification[18].value>threshold && row > 199 && row < 300) ||
        (result.classification[19].value>threshold && row > 299 && row < 400) ||
        (result.classification[20].value>threshold &&row > 399)){
      
      delay(950);

    }
    else{
      
      while(!BLE.begin());
      for (size_t ix = 0; ix < EI_CLASSIFIER_LABEL_COUNT - 5; ) { // The last 5 element is accuracy values
        String dataToSend = String(result.classification[ix++].value) + "," + String(result.classification[ix++].value) + "," + String(result.classification[ix++].value) + "," + String(result.classification[ix++].value) ; 
        BLE.setLocalName(dataToSend.c_str());
        BLE.setAdvertisedServiceUuid("180C");
        BLE.advertise();
      }

      BLE.end();
    }
    
      
  }
    
  BLE.end();
  //delay(1000);
  //while(!BLE.begin());
  delay(100000);
}


/************************************/
void setup(){
  //Serial_Settings();
  PowerSave_Settings();
  BLE_Settings();
}

/************************************/
void loop() {
  Inference_BLE();
}

/************************************/
int main(void){
  init();
  initVariant();

  //Disabling UART0 (saves around 300-500¦ÌA)
  NRF_UART0->TASKS_STOPTX = 1;
  NRF_UART0->TASKS_STOPRX = 1;
  NRF_UART0->ENABLE = 0;
  //NRF_POWER->SYSTEMOFF = 1;

  *(volatile uint32_t *)0x40002FFC = 0;
  *(volatile uint32_t *)0x40002FFC;
  *(volatile uint32_t *)0x40002FFC = 1; //Setting up UART registers again due to a library issue

  //Removing USB CDC feature
  //#if defined(SERIAL_CDC)
  //  PluggableUSBD().begin();
  //  SerialUSB.begin(115200);
  //#endif

  setup();
  for(;;){
    loop();
  //If you won't be using serial communication comment next line
  //    if(arduino::serialEventRun) arduino::serialEventRun();
  }
  return 0;
}



